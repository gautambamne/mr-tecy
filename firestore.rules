rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      // Check if the user document has role 'admin'
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/user/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // ===== User Collection =====
    
    match /user/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow delete: if isAdmin();
    }

    // ===== Partners Collection =====
    
    match /partners/{partnerId} {
      allow read: if true; // Public read - customers need to see partners
      allow create, update, delete: if isAdmin(); // Only admins can manage partners
    }

    // ===== Services Collection =====
    
    match /services/{serviceId} {
      allow read: if true; // Public catalog
      allow create, update, delete: if isAdmin(); // Only admins can manage services
    }

    // ===== Bookings Collection =====
    
    match /bookings/{bookingId} {
      // Anyone authenticated can create a booking
      allow create: if isAuthenticated() && 
                       request.resource.data.customerId == request.auth.uid;
      
      // Customers can read their own bookings, partners can read assigned bookings, admins see all
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.partnerId == request.auth.uid ||
        isAdmin()
      );
      
      // Customers can cancel their own pending/accepted bookings
      // Partners/admins can update status
      allow update: if isAuthenticated() && (
        // Customer cancelling their own booking
        (resource.data.customerId == request.auth.uid &&
         resource.data.status in ['pending', 'accepted'] &&
         request.resource.data.status == 'cancelled') ||
        // Partner updating assigned booking status
        (resource.data.partnerId == request.auth.uid &&
         request.resource.data.status in ['accepted', 'in_progress', 'completed']) ||
        // Admin can update anything
        isAdmin()
      );
      
      allow delete: if isAdmin(); // Only admins can delete bookings
    }

    // ===== Reviews Collection =====
    
    match /reviews/{reviewId} {
      // Anyone can read reviews (public)
      allow read: if true;
      
      // Only the booking customer can create a review
      allow create: if isAuthenticated() &&
                       request.resource.data.customerId == request.auth.uid &&
                       // Ensure booking exists and is completed
                       exists(/databases/$(database)/documents/bookings/$(request.resource.data.bookingId)) &&
                       get(/databases/$(database)/documents/bookings/$(request.resource.data.bookingId)).data.status == 'completed';
      
      // No updates allowed after submission (immutable)
      allow update: if false;
      
      // Only admins can delete reviews
      allow delete: if isAdmin();
    }

    // ===== Default Deny =====
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

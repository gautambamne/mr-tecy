rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      // Check if the user document has role 'admin'
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/user/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // ===== User Collection =====
    
    // ===== User Collection =====
    
    match /user/{userId} {
      allow read: if isAuthenticated() && (
        isOwner(userId) || 
        isAdmin() || 
        resource.data.role == 'partner'
      );
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Admin can update any user, users can update themselves
      // BUT users cannot change their own role or status (security critical)
      allow update: if isAuthenticated() && (
        (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status'])) ||
        isAdmin() ||
        // Allow updating rating and reviewCount (for review system)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'reviewCount'])
      );
      
      allow delete: if isAdmin();
      
      // Allow admins to list/query all users. 
      // Also allow querying for partners (since we allow reading individual partner docs)
      allow list: if isAdmin() || (
        isAuthenticated() && resource.data.role == 'partner'
      );
    }

    // ===== Users Collection (plural) =====
    // Added to support profile updates from the profile page
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow delete: if isAdmin();
    }

    // ===== Partners Collection =====
    
    match /partners/{partnerId} {
      allow read: if true; // Public read - customers need to see partners
      allow create, update, delete: if isAdmin(); // Only admins can manage partners
    }

    // ===== Services Collection =====
    
    match /services/{serviceId} {
      allow read: if true; // Public catalog
      allow create, update, delete: if isAdmin(); // Only admins can manage services
    }

    // ===== Bookings Collection =====
    
    match /bookings/{bookingId} {
      // Anyone authenticated can create a booking
      allow create: if isAuthenticated() && 
                       request.resource.data.customerId == request.auth.uid;
      
      // Customers can read their own bookings, partners can read assigned bookings, admins see all
      allow get: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.partnerId == request.auth.uid ||
        isAdmin()
      );
      
      // AVAILABILITY CHECK: Allow authenticated users to list/query bookings
      // This is needed for checking partner availability when making new bookings
      // Users can see booking exists but not necessarily all details
      allow list: if isAuthenticated();
      
      // Helper function to validate status transitions
      function isValidStatusTransition(oldStatus, newStatus) {
        return (
          // Same status is allowed (no-op)
          oldStatus == newStatus ||
          // Pending can go to accepted or cancelled
          (oldStatus == 'pending' && newStatus in ['accepted', 'cancelled']) ||
          // Accepted can go to in_progress or cancelled
          (oldStatus == 'accepted' && newStatus in ['in_progress', 'cancelled']) ||
          // In Progress can go to completed or cancelled
          (oldStatus == 'in_progress' && newStatus in ['completed', 'cancelled'])
          // Completed and Cancelled are terminal - no transitions allowed
        );
      }
      
      // Customers can cancel their own pending/accepted bookings
      // Partners/admins can update status with validation
      allow update: if isAuthenticated() && (
        // Customer cancelling their own booking
        (resource.data.customerId == request.auth.uid &&
         resource.data.status in ['pending', 'accepted'] &&
         request.resource.data.status == 'cancelled') ||
        // Partner updating assigned booking status with validation
        (resource.data.partnerId == request.auth.uid &&
         isValidStatusTransition(resource.data.status, request.resource.data.status)) ||
        // Admin can update with validation
        (isAdmin() && isValidStatusTransition(resource.data.status, request.resource.data.status)) ||
        // Allow customer to mark booking as reviewed
        (resource.data.customerId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reviewed']) &&
         request.resource.data.reviewed == true)
      );
      
      allow delete: if isAdmin(); // Only admins can delete bookings
    }

    // ===== Reviews Collection =====
    
    match /reviews/{reviewId} {
      // Anyone can read reviews (public)
      allow read: if true;
      
      // Only the booking customer can create a review
      allow create: if isAuthenticated() &&
                       request.resource.data.customerId == request.auth.uid &&
                       // Ensure booking exists and is completed
                       exists(/databases/$(database)/documents/bookings/$(request.resource.data.bookingId)) &&
                       get(/databases/$(database)/documents/bookings/$(request.resource.data.bookingId)).data.status == 'completed';
      
      // No updates allowed after submission (immutable)
      allow update: if false;
      
      // Only admins can delete reviews
      allow delete: if isAdmin();
    }

    // ===== Partner Applications Collection =====
    
    match /partnerApplications/{applicationId} {
      // Authenticated users can create their own application
      // - Document ID MUST match their UID
      // - userId field MUST match their UID
      // - status MUST be 'pending' on creation
      // - Validate required non-timestamp fields exist
      allow create: if isAuthenticated() && 
                       applicationId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.keys().hasAll([
                         'userId', 'fullName', 'email', 'phone', 
                         'skills', 'serviceArea', 'experience', 'status'
                       ]);
      
      // Users can read their own application, admins can read all, 
      // AND customers can read to see partner details
      allow read: if isAuthenticated();
      
      // ONLY admins can update applications (prevent users from changing status)
      allow update: if isAdmin();
      
      // ONLY admins can delete applications
      allow delete: if isAdmin();
    }

    // ===== Notifications Collection =====

    
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // System/admins create notifications, but also users trigger them for others (e.g. booking request)
      allow create: if isAuthenticated();
      
      // Users can mark their own notifications as read
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       // Only allow updating the 'read' field
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Only admins can delete notifications
      allow delete: if isAdmin();
    }

    // ===== Default Deny =====
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
